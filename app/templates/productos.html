{% extends "base.html" %}

{% block title %}Gestión de Productos - POS XYZ System{% endblock %}
{% block page_title %}Gestión de Productos{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="fas fa-box me-2"></i>Gestión de Productos
            </h1>
            <button class="btn btn-primary" onclick="showProductModal()">
                <i class="fas fa-plus me-2"></i>Nuevo Producto
            </button>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="searchProducts" placeholder="Buscar productos...">
            <button class="btn btn-outline-secondary" onclick="clearSearch()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="stockFilter">
            <option value="">Todos los productos</option>
            <option value="available">Con stock</option>
            <option value="low">Stock bajo</option>
            <option value="out">Sin stock</option>
        </select>
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
            <i class="fas fa-search me-2"></i>Filtrar
        </button>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>Lista de Productos
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="productsTable">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando productos...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">
                    <i class="fas fa-plus me-2"></i>Nuevo Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="mb-3">
                        <label for="productName" class="form-label">Nombre del Producto *</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">Precio *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="productPrice" step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productStock" class="form-label">Stock Inicial *</label>
                                <input type="number" class="form-control" id="productStock" min="0" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">
                    <i class="fas fa-save me-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let products = [];
let filteredProducts = [];
let productModal;
let isEditing = false;

document.addEventListener('DOMContentLoaded', async () => {
    productModal = new bootstrap.Modal(document.getElementById('productModal'));
    await loadProducts();
    setupEventListeners();
});

function setupEventListeners() {
    const searchInput = document.getElementById('searchProducts');
    const debouncedSearch = debounce(() => {
        applyFilters();
    }, 300);
    
    searchInput.addEventListener('input', debouncedSearch);
}

async function loadProducts() {
    try {
        products = await api.getProducts();
        applyFilters();
    } catch (error) {
        console.error('Error loading products:', error);
        showAlert('Error cargando productos', 'danger');
        document.getElementById('productsTable').innerHTML = 
            '<tr><td colspan="7" class="text-center text-danger">Error cargando productos</td></tr>';
    }
}

function applyFilters() {
    const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
    const stockFilter = document.getElementById('stockFilter').value;
    
    filteredProducts = products.filter(product => {
        // Search filter
        const matchesSearch = product.nombre.toLowerCase().includes(searchTerm) ||
                            (product.descripcion && product.descripcion.toLowerCase().includes(searchTerm));
        
        // Stock filter
        let matchesStock = true;
        switch (stockFilter) {
            case 'available':
                matchesStock = product.stock > 0;
                break;
            case 'low':
                matchesStock = product.stock > 0 && product.stock < 10;
                break;
            case 'out':
                matchesStock = product.stock === 0;
                break;
        }
        
        return matchesSearch && matchesStock;
    });
    
    renderProductsTable();
}

function renderProductsTable() {
    const tbody = document.getElementById('productsTable');
    
    if (filteredProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No se encontraron productos</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredProducts.map(product => `
        <tr>
            <td>#${product.id}</td>
            <td><strong>${product.nombre}</strong></td>
            <td>${product.descripcion || '-'}</td>
            <td>${formatCurrency(product.precio)}</td>
            <td><span class="badge ${getStockBadgeClass(product.stock)}">${product.stock}</span></td>
            <td>${getStockStatus(product.stock)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editProduct(${product.id})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getStockBadgeClass(stock) {
    if (stock === 0) return 'bg-danger';
    if (stock < 10) return 'bg-warning text-dark';
    return 'bg-success';
}

function getStockStatus(stock) {
    if (stock === 0) return '<span class="text-danger"><i class="fas fa-times-circle"></i> Sin Stock</span>';
    if (stock < 10) return '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Stock Bajo</span>';
    return '<span class="text-success"><i class="fas fa-check-circle"></i> Disponible</span>';
}

function clearSearch() {
    document.getElementById('searchProducts').value = '';
    document.getElementById('stockFilter').value = '';
    applyFilters();
}

function showProductModal() {
    isEditing = false;
    const form = document.getElementById('productForm');
    form.reset();
    document.getElementById('productId').value = '';
    
    document.getElementById('productModalTitle').innerHTML = 
        '<i class="fas fa-plus me-2"></i>Nuevo Producto';
    
    productModal.show();
}

function editProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    isEditing = true;
    
    document.getElementById('productId').value = product.id;
    document.getElementById('productName').value = product.nombre;
    document.getElementById('productDescription').value = product.descripcion || '';
    document.getElementById('productPrice').value = product.precio;
    document.getElementById('productStock').value = product.stock;
    
    document.getElementById('productModalTitle').innerHTML = 
        '<i class="fas fa-edit me-2"></i>Editar Producto';
    
    productModal.show();
}

async function saveProduct() {
    const form = document.getElementById('productForm');
    const saveBtn = document.getElementById('saveProductBtn');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const productData = {
        nombre: document.getElementById('productName').value,
        descripcion: document.getElementById('productDescription').value || null,
        precio: parseFloat(document.getElementById('productPrice').value),
        stock: parseInt(document.getElementById('productStock').value)
    };
    
    showLoading(saveBtn);
    
    try {
        if (isEditing) {
            const productId = document.getElementById('productId').value;
            await api.updateProduct(productId, productData);
            showAlert('Producto actualizado correctamente', 'success');
        } else {
            await api.createProduct(productData);
            showAlert('Producto creado correctamente', 'success');
        }
        
        productModal.hide();
        await loadProducts();
        
    } catch (error) {
        console.error('Error saving product:', error);
        showAlert('Error guardando producto: ' + error.message, 'danger');
    } finally {
        hideLoading(saveBtn, '<i class="fas fa-save me-2"></i>Guardar');
    }
}

async function deleteProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!confirmDelete(`¿Estás seguro de que deseas eliminar el producto "${product.nombre}"?`)) {
        return;
    }
    
    try {
        await api.deleteProduct(productId);
        showAlert('Producto eliminado correctamente', 'success');
        await loadProducts();
    } catch (error) {
        console.error('Error deleting product:', error);
        showAlert('Error eliminando producto', 'danger');
    }
}
</script>
{% endblock %}
